import{_ as s,o as n,c as a,a as l}from"./app.a5c890c8.js";const m=JSON.parse('{"title":"\u5173\u4E8Elove2d\u5F15\u64CErequire\u5BFC\u5165C/C++\u7F16\u5199\u7684.dll/.so\u6269\u5C55\u5E93\u95EE\u9898","description":"","frontmatter":{"title":"\u5173\u4E8Elove2d\u5F15\u64CErequire\u5BFC\u5165C/C++\u7F16\u5199\u7684.dll/.so\u6269\u5C55\u5E93\u95EE\u9898","date":"2021-08-29T00:00:00.000Z","tags":["lua","love2d","C++","\u5B89\u5353","\u52A8\u6001\u94FE\u63A5\u5E93","\u7B14\u8BB0"]},"headers":[{"level":2,"title":"\u6E90\u7801","slug":"\u6E90\u7801","link":"#\u6E90\u7801","children":[{"level":3,"title":"test.c","slug":"test-c","link":"#test-c","children":[]}]},{"level":2,"title":"\u7F16\u8BD1","slug":"\u7F16\u8BD1","link":"#\u7F16\u8BD1","children":[{"level":3,"title":"windows \u548C linux","slug":"windows-\u548C-linux","link":"#windows-\u548C-linux","children":[]},{"level":3,"title":"\u5B89\u5353","slug":"\u5B89\u5353","link":"#\u5B89\u5353","children":[]}]},{"level":2,"title":"\u8C03\u7528","slug":"\u8C03\u7528","link":"#\u8C03\u7528","children":[]}],"relativePath":"posts/love2d-require-c-library.md"}'),e={name:"posts/love2d-require-c-library.md"},p=l(`<h2 id="\u6E90\u7801" tabindex="-1">\u6E90\u7801 <a class="header-anchor" href="#\u6E90\u7801" aria-hidden="true">#</a></h2><p>\u6E38\u620F\u9879\u76EE\u4E2D\u9047\u5230\u7684\u72D7\u5C4E\u95EE\u9898\uFF0C\u5206\u4EAB\u4E00\u4E0B\u89E3\u51B3\u7ECF\u9A8C\uFF0C\u4EE5\u4E00\u4E2A\u6700\u57FA\u672C\u7684\u7A0B\u5E8F\u4E3A\u4F8B\uFF1A</p><h3 id="test-c" tabindex="-1"><code>test.c</code> <a class="header-anchor" href="#test-c" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#CF222E;">#include</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&quot;lua.h&quot;</span></span>
<span class="line"><span style="color:#CF222E;">#include</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&quot;lualib.h&quot;</span></span>
<span class="line"><span style="color:#CF222E;">#include</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&quot;lauxlib.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">static</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">int</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">about</span><span style="color:#24292F;">(lua_State </span><span style="color:#CF222E;">*</span><span style="color:#953800;">L</span><span style="color:#24292F;">){</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">lua_pushstring</span><span style="color:#24292F;">(L,</span><span style="color:#0A3069;">&quot;test by flaribbit&quot;</span><span style="color:#24292F;">);</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;">;</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">static</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">const</span><span style="color:#24292F;"> </span><span style="color:#CF222E;">struct</span><span style="color:#24292F;"> luaL_Reg funcList</span><span style="color:#CF222E;">[]=</span></span>
<span class="line"><span style="color:#24292F;">{</span></span>
<span class="line"><span style="color:#24292F;">    {</span><span style="color:#0A3069;">&quot;about&quot;</span><span style="color:#24292F;">, about},</span></span>
<span class="line"><span style="color:#24292F;">    {</span><span style="color:#0550AE;">0</span><span style="color:#24292F;">, </span><span style="color:#0550AE;">0</span><span style="color:#24292F;">}</span></span>
<span class="line"><span style="color:#24292F;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CF222E;">int</span><span style="color:#24292F;"> </span><span style="color:#8250DF;">luaopen_test</span><span style="color:#24292F;">(lua_State </span><span style="color:#CF222E;">*</span><span style="color:#953800;">L</span><span style="color:#24292F;">)</span></span>
<span class="line"><span style="color:#24292F;">{</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#8250DF;">luaL_register</span><span style="color:#24292F;">(L, </span><span style="color:#0A3069;">&quot;test&quot;</span><span style="color:#24292F;">, funcList);</span></span>
<span class="line"><span style="color:#24292F;">    </span><span style="color:#CF222E;">return</span><span style="color:#24292F;"> </span><span style="color:#0550AE;">1</span><span style="color:#24292F;">;</span></span>
<span class="line"><span style="color:#24292F;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="\u7F16\u8BD1" tabindex="-1">\u7F16\u8BD1 <a class="header-anchor" href="#\u7F16\u8BD1" aria-hidden="true">#</a></h2><h3 id="windows-\u548C-linux" tabindex="-1">windows \u548C linux <a class="header-anchor" href="#windows-\u548C-linux" aria-hidden="true">#</a></h3><p>\u5728windows\u7CFB\u7EDF\u548Clinux\u7CFB\u7EDF\u4E2D\uFF0C\u53EF\u4EE5\u76F4\u63A5\u4F7F\u7528gcc\u7F16\u8BD1\uFF0C\u6CE8\u610F\u94FE\u63A5<code>lua51.dll</code>\u6216\u8005<code>libluajit.so</code>\uFF0C\u8BB0\u5F97\u6539\u6389\u4E0B\u9762\u547D\u4EE4\u4E2D\u7684<code>path/to/</code></p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#24292F;">gcc test.c path/to/lua51.dll -s -O2 -DNDEBUG -o test.dll</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#24292F;">gcc test.c path/to/libluajit.so -s -O2 -DNDEBUG -o libtest.so</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>\u7136\u540E\u5728lua\u4E2D\u8C03\u7528<code>require&quot;test&quot;</code>\u5C31\u53EF\u4EE5\u5BFC\u5165\u4F7F\u7528\u4E86\uFF0C\u6253\u5305\u6E38\u620F\u7684\u65F6\u5019\u8BB0\u5F97\u628A\u5E93\u653E\u5728\u5916\u9762\uFF0C\u548C<code>love.dll</code>\u653E\u5728\u4E00\u8D77\uFF0C\u4E0D\u8981\u585E\u8FDB<code>game.love</code>\u6216\u8005<code>exe</code></p><p>android\u7CFB\u7EDF\u5C31\u6BD4\u8F83\u6076\u5FC3\u4E86\uFF0C\u81EA\u5907NDK\uFF0C\u4EE5\u4E0B\u6559\u7A0B\u5199\u4E8Ewindows\u7CFB\u7EDF\uFF0C\u5728<code>test.c</code>\u6240\u5728\u7684\u76EE\u5F55\u521B\u5EFA<code>Android.mk</code>\u548C<code>Application.mk</code>\uFF0C\u4E0B\u9762\u7684\u4EE3\u7801\u4E2D\u8BB0\u5F97\u4FEE\u6539<code>path/to/</code>\uFF0C\u4E3Aliblove.so\u6240\u5728\u7684\u76EE\u5F55\uFF08\u53EF\u4EE5\u76F4\u63A5\u89E3\u538Blove2d\u7684\u5B89\u88C5\u5305\u62FF\uFF09</p><h3 id="\u5B89\u5353" tabindex="-1">\u5B89\u5353 <a class="header-anchor" href="#\u5B89\u5353" aria-hidden="true">#</a></h3><h4 id="android-mk" tabindex="-1"><code>Android.mk</code> <a class="header-anchor" href="#android-mk" aria-hidden="true">#</a></h4><div class="language-makefile line-numbers-mode"><button class="copy"></button><span class="lang">makefile</span><pre><code><span class="line"><span style="color:#24292F;">LOCAL_PATH := </span><span style="color:#0A3069;">$(</span><span style="color:#0550AE;">call</span><span style="color:#0A3069;"> my-dir)</span></span>
<span class="line"><span style="color:#CF222E;">include</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">$(</span><span style="color:#24292F;">CLEAR_VARS</span><span style="color:#0A3069;">)</span></span>
<span class="line"><span style="color:#24292F;">LOCAL_MODULE := test</span></span>
<span class="line"><span style="color:#24292F;">LOCAL_SRC_FILES := test.c</span></span>
<span class="line"><span style="color:#24292F;">LOCAL_LDFLAGS := -Lpath/to/</span><span style="color:#0A3069;">$(</span><span style="color:#24292F;">TARGET_ARCH_ABI</span><span style="color:#0A3069;">)</span><span style="color:#24292F;"> -llove</span></span>
<span class="line"><span style="color:#24292F;">LOCAL_C_INCLUDES := include</span></span>
<span class="line"><span style="color:#CF222E;">include</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">$(</span><span style="color:#24292F;">BUILD_SHARED_LIBRARY</span><span style="color:#0A3069;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="application-mk" tabindex="-1"><code>Application.mk</code> <a class="header-anchor" href="#application-mk" aria-hidden="true">#</a></h4><div class="language-makefile line-numbers-mode"><button class="copy"></button><span class="lang">makefile</span><pre><code><span class="line"><span style="color:#24292F;">APP_CPPFLAGS := -frtti </span></span>
<span class="line"><span style="color:#24292F;">APP_LDFLAGS := -latomic</span></span>
<span class="line"><span style="color:#24292F;">APP_ABI := armeabi-v7a arm64-v8a</span></span>
<span class="line"><span style="color:#24292F;">APP_PLATFORM := android-16</span></span>
<span class="line"><span style="color:#24292F;">APP_OPTIM := release</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u7136\u540E\u8C03\u7528<code>ndk-build</code>\u7F16\u8BD1\uFF0C\u65E5\u5E38\u8BB0\u5F97\u4FEE\u6539<code>path/to/</code></p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#24292F;">path/to/ndk-build NDK_PROJECT_PATH=. NDK_APPLICATION_MK=Application.mk APP_BUILD_SCRIPT=Android.mk</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>\u4F1A\u62A5\u53EF\u80FD\u9519\u8BEF\u94FE\u63A5\u7684warning\uFF0C\u95EE\u9898\u4E0D\u5927\uFF0C\u7F16\u8BD1\u5B8C\u6210\u540E\u4F1A\u5728<code>libs</code>\u6587\u4EF6\u5939\u91CC\u5F97\u5230\u4E24\u4E2A<code>libtest.so</code></p><h2 id="\u8C03\u7528" tabindex="-1">\u8C03\u7528 <a class="header-anchor" href="#\u8C03\u7528" aria-hidden="true">#</a></h2><p>\u6700\u540E\u7F16\u5199lua\u7A0B\u5E8F\uFF0C\u8FD9\u91CC\u6709\u4E2A\u5DE8\u5751\uFF0C<code>*.so</code>\u5FC5\u987B\u653E\u5230<code>/data/data/package.name</code>\u91CC\u9762\u624D\u80FD\u88AB<code>require</code>\u6B63\u786E\u52A0\u8F7D\uFF0C\u5426\u5219\u4F1A\u7206\u7C7B\u4F3C\u4E0B\u9762\u7684\u795E\u79D8\u9519\u8BEF</p><div class="language-txt line-numbers-mode"><button class="copy"></button><span class="lang">txt</span><pre><code><span class="line"><span style="color:#24292f;">Error</span></span>
<span class="line"><span style="color:#24292f;"></span></span>
<span class="line"><span style="color:#24292f;">error loading module &#39;test&#39; from file &#39;/sdcard/libtest.so&#39;:</span></span>
<span class="line"><span style="color:#24292f;">dlopen failed: library &quot;/sdcard/libtest.so&quot; needed or dlopened by &quot;/data/app/org.love2d.android.embed-cfg2TKQ-XsSj13FxWVvTUw==/lib/arm64/liblove.so&quot; is not accessible for the namespace &quot;classloader-namespace&quot;</span></span>
<span class="line"><span style="color:#24292f;"></span></span>
<span class="line"><span style="color:#24292f;">Traceback</span></span>
<span class="line"><span style="color:#24292f;">[C]: at 0x7a3d813a7c</span></span>
<span class="line"><span style="color:#24292f;">[C]: in function &#39;require&#39;</span></span>
<span class="line"><span style="color:#24292f;">/sdcard/prog.lua:2: in main chunk</span></span>
<span class="line"><span style="color:#24292f;">[C]: in function &#39;require&#39;</span></span>
<span class="line"><span style="color:#24292f;">main.lua:2: in main chunk</span></span>
<span class="line"><span style="color:#24292f;">[C]: in function &#39;require&#39;</span></span>
<span class="line"><span style="color:#24292f;">[C]: in function &#39;xpcall&#39;</span></span>
<span class="line"><span style="color:#24292f;">[C]: in function &#39;xpcall&#39;</span></span>
<span class="line"><span style="color:#24292f;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>\u90A3\u4E48\u95EE\u9898\u6765\u4E86\uFF0C\u5982\u4F55\u653E\u5230<code>/data/data/package.name</code>\u91CC\u9762\u5462\u2026\uFF1F</p><p>\u628A<code>*.so</code>\u6587\u4EF6\u6253\u5305\u8FDB<code>game.love</code>\uFF0C\u7136\u540E\u7528\u4E0B\u9762\u7684\u4EE3\u7801copy\u5230save\u6587\u4EF6\u5939\u91CC\uFF0C\u4E5F\u7B97\u662F\u4E2A\u529E\u6CD5\u5427\u3002</p><div class="language-lua line-numbers-mode"><button class="copy"></button><span class="lang">lua</span><pre><code><span class="line"><span style="color:#0550AE;">package.cpath</span><span style="color:#CF222E;">=</span><span style="color:#0A3069;">&#39;/data/data/org.love2d.android.embed/files/save/archive/lib?.so;&#39;</span><span style="color:#CF222E;">..</span><span style="color:#0550AE;">package.cpath</span></span>
<span class="line"><span style="color:#24292F;">love.</span><span style="color:#0550AE;">filesystem</span><span style="color:#24292F;">.</span><span style="color:#0550AE;">write</span><span style="color:#24292F;">(</span><span style="color:#0A3069;">&quot;libtest.so&quot;</span><span style="color:#24292F;">, love.</span><span style="color:#0550AE;">filesystem</span><span style="color:#24292F;">.</span><span style="color:#0550AE;">read</span><span style="color:#24292F;">(</span><span style="color:#0A3069;">&quot;libtest.so&quot;</span><span style="color:#24292F;">))</span></span>
<span class="line"><span style="color:#0550AE;">require</span><span style="color:#24292F;"> </span><span style="color:#0A3069;">&quot;test&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>it just works</p><p><a href="https://github.com/flaribbit/love2d-c-library-template" target="_blank" rel="noreferrer">github</a></p>`,27),o=[p];function c(r,t,i,d,u,b){return n(),a("div",null,o)}const F=s(e,[["render",c]]);export{m as __pageData,F as default};
